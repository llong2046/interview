# SQL 核心面试要点

### 一、 SQL基础命令

*   **DDL (Data Definition Language - 数据定义语言)**
    *   **作用**: 用于定义和管理数据库对象（如表、索引、视图）。
    *   **核心命令**: `CREATE` (创建), `ALTER` (修改), `DROP` (删除), `TRUNCATE` (清空表数据)。

*   **DML (Data Manipulation Language - 数据操作语言)**
    *   **作用**: 用于操作数据库中的数据。
    *   **核心命令**: `SELECT` (查询), `INSERT` (插入), `UPDATE` (更新), `DELETE` (删除)。

*   **DCL (Data Control Language - 数据控制语言)**
    *   **作用**: 用于授予或撤销数据库用户的权限。
    *   **核心命令**: `GRANT` (授权), `REVOKE` (撤销权限)。

*   **TCL (Transaction Control Language - 事务控制语言)**
    *   **作用**: 用于管理数据库中的事务。
    *   **核心命令**: `COMMIT` (提交), `ROLLBACK` (回滚), `SAVEPOINT` (设置保存点)。

```
助记关键词: 定义, 操作, 授权, 事务
助记/类比:
DDL: 建筑师，负责设计房子的蓝图（`CREATE TABLE`）。
DML: 装修工，负责往房子里搬入或移走家具（`INSERT`, `UPDATE`）。
DCL: 物业保安，负责发放和回收小区的门禁卡（`GRANT`, `REVOKE`）。
TCL: 你在玩游戏时的“存档”和“读档”功能（`COMMIT`, `ROLLBACK`）。
```

### 二、 核心查询与子句

*   **`SELECT` 查询语句结构**
    *   **`SELECT`**: 选择要显示的列。
    *   **`FROM`**: 指定从哪个表中查询数据。
    *   **`WHERE`**: **行级过滤**。在数据分组前，根据指定条件过滤单行数据。
    *   **`GROUP BY`**: **分组**。将数据行按一列或多列的值进行分组，常与聚合函数（`COUNT`, `SUM`, `AVG`等）配合使用。
    *   **`HAVING`**: **组级过滤**。在数据分组后，根据指定条件过滤整个分组。
    *   **`ORDER BY`**: **排序**。对最终的结果集进行排序。

*   **SQL查询执行顺序 (逻辑上)**
    1.  `FROM`
    2.  `WHERE`
    3.  `GROUP BY`
    4.  `HAVING`
    5.  `SELECT`
    6.  `ORDER BY`

```
助记关键词: 行过滤(WHERE), 分组(GROUP BY), 组过滤(HAVING), 排序(ORDER BY), 执行顺序
助记/类比:
查询过程就像在仓库里挑货：
1. `FROM`: 确定要去哪个仓库（表）。
2. `WHERE`: 在仓库里，只挑出红色的箱子（行过滤）。
3. `GROUP BY`: 把红色的箱子按品牌堆成不同的小堆（分组）。
4. `HAVING`: 只留下那些超过10箱的小堆（组过滤）。
5. `SELECT`: 决定要记录这些货堆的什么信息（比如品牌名和总箱数）。
6. `ORDER BY`: 最后，把这些留下的货堆按箱数从多到少排列（排序）。
```

### 三、 多表连接 (Table Joins)

*   **`INNER JOIN` (内连接)**
    *   **作用**: 返回两个表中**键值匹配**的记录。只显示两个表的交集。

*   **`LEFT JOIN` (左连接)**
    *   **作用**: 返回左表中的**所有**记录，以及右表中匹配的记录。如果右表中没有匹配项，则结果为 `NULL`。

*   **`RIGHT JOIN` (右连接)**
    *   **作用**: 与左连接相反，返回右表中的**所有**记录，以及左表中匹配的记录。

*   **`FULL OUTER JOIN` (全外连接)**
    *   **作用**: 返回左表和右表中所有的记录。只要其中一个表存在匹配，就会列出。是左连接和右连接的并集。

*   **`CROSS JOIN` (交叉连接)**
    *   **作用**: 返回左表中的每一行与右表中的每一行组合的结果（笛卡尔积）。

```
助记关键词: 交集(INNER), 左全(LEFT), 右全(RIGHT), 并集(FULL)
助记/类比:
想象两个微信群（表A，表B）的好友列表：
INNER JOIN: 两个群里都有的人。
LEFT JOIN: A群的所有人，以及他们中同时也在B群的人。
FULL OUTER JOIN: A群和B群的所有人，去掉重复的。
CROSS JOIN: A群的每个人都和B群的每个人都加一遍好友，看能组成多少对CP。
```

### 四、 索引与性能优化

*   **索引 (Index)**
    *   **定义**: 一种特殊的数据库结构，用于**加快数据检索速度**。它类似于书籍的目录。
    *   **原理**: 通过创建指向数据表中特定数据行的指针，实现快速查找。最常用的是 **B-Tree** 索引。
    *   **优缺点**: 极大提升`SELECT`查询速度，但会降低`INSERT`、`UPDATE`、`DELETE`的速度，因为修改数据时也需要更新索引。

*   **聚集索引 (Clustered Index) vs. 非聚集索引 (Non-Clustered Index)**
    *   **聚集索引**: 决定了表中数据的**物理存储顺序**。一张表只能有一个聚集索引。找到了索引就找到了数据。
    *   **非聚集索引**: 索引的逻辑顺序与磁盘上行的物理存储顺序不同。索引中包含一个指向数据行的指针。一张表可以有多个非聚集索引。

```
助记关键词: 空间换时间, B-Tree结构, 物理排序, 目录指针
助记/类比:
索引: 一本书的目录。没有目录，你找一个知识点需要翻遍整本书（全表扫描）。有了目录，你可以快速定位到页码。
聚集索引: 这本书的内容本身就是按章节顺序（物理）排列的，目录就是章节列表。
非聚集索引: 书末的“关键词索引”，它是一个独立的列表，告诉你“某个关键词”出现在哪些页码，你需要根据页码二次查找。
```

### 五、 事务与并发控制

*   **ACID属性**
    *   **原子性 (Atomicity)**: 事务中的所有操作，要么全部成功，要么全部失败回滚。
    *   **一致性 (Consistency)**: 事务使数据库从一个一致性状态转移到另一个一致性状态。
    *   **隔离性 (Isolation)**: 多个并发事务之间互不干扰。
    *   **持久性 (Durability)**: 事务一旦提交，其结果就是永久性的。

*   **并发问题**
    *   **脏读 (Dirty Read)**: 一个事务读取了另一个未提交事务的数据。
    *   **不可重复读 (Non-Repeatable Read)**: 在同一事务内，多次读取同一数据，结果不同（因为数据被其他事务修改并提交了）。
    *   **幻读 (Phantom Read)**: 在同一事务内，多次查询符合某个范围的记录，结果集数量不同（因为其他事务插入了新数据）。

*   **隔离级别 (Isolation Levels)**
    1.  **读未提交 (Read Uncommitted)**: 级别最低，可能发生以上所有问题。
    2.  **读已提交 (Read Committed)**: 避免脏读。大多数数据库的默认级别。
    3.  **可重复读 (Repeatable Read)**: 避免脏读和不可重复读。MySQL的默认级别。
    4.  **可串行化 (Serializable)**: 级别最高，避免所有并发问题，但性能最差。

```
助记关键词: ACID, 脏读/不可重复读/幻读, 四个隔离级别
助记/类比:
事务: 你去银行ATM取款，插卡、输密码、输入金额、取钱、退卡，这一系列操作必须是“原子”的，要么全成功，要么全失败。
隔离级别: 多个人同时在编辑一个在线文档。
读未提交: 你能看到别人正在打字但还没保存的内容（脏读）。
读已提交: 你只能看到别人点击“保存”之后的内容。
可重复读: 你刷新页面，之前读过的一段话不会变样，但别人可能在文档末尾新增了段落（幻读）。
可串行化: 你在编辑时，整个文档被锁定，别人完全无法操作，只能等你搞完。
```

### 六、 高级查询技巧

*   **子查询 (Subquery)**
    *   **定义**: 嵌套在另一个SQL查询（主查询）中的查询。可以出现在`SELECT`, `FROM`, `WHERE`等子句中。

*   **CTE (Common Table Expression - 公用表表达式)**
    *   **定义**: 使用 `WITH` 关键字定义的一个临时的、命名的结果集，可以在后续的查询中多次引用。
    *   **优势**: 提高复杂查询的可读性和可维护性，并可以实现递归查询。

*   **窗口函数 (Window Functions)**
    *   **定义**: 对一组与当前行相关的表行（这个组被称为“窗口”）执行计算。与聚合函数不同，它不会将多行合并为一行，而是为每一行都返回一个值。
    *   **常用函数**: `ROW_NUMBER()`, `RANK()`, `DENSE_RANK()` (用于排名), `LEAD()`, `LAG()` (用于获取上/下N行的值)。

```
助记关键词: 嵌套查询, 临时表(WITH), 跨行计算, 排名函数
助记/类比:
CTE: 像在写一篇长论文前，先在草稿纸上定义好几个关键的中间结论（`WITH`子句），然后在正文里直接引用这些结论的代号，让文章结构更清晰。
窗口函数: 像在Excel表格里计算“移动平均值”或“同比增长率”。对于每一行数据，它都可以看到它前面或后面的几行数据来进行计算，但不会把这些行合并掉。
```
